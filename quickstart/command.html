

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Exposing Operations: Command Service &mdash; Minos Documentation  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Exposing Information: Query Service" href="query.html" />
    <link rel="prev" title="Modeling the Domain: Aggregates" href="aggregate.html" />
    <link href="../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Minos Documentation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="_toc.html">QuickStart</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="setup.html">Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="aggregate.html">Modeling the Domain: Aggregates</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Exposing Operations: Command Service</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setting-up-the-service">Setting up the service!</a></li>
<li class="toctree-l3"><a class="reference internal" href="#exposing-exam-creation">Exposing <code class="docutils literal notranslate"><span class="pre">Exam</span></code> creation…</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-exam-questions">Adding <code class="docutils literal notranslate"><span class="pre">Exam</span></code> questions!</a></li>
<li class="toctree-l3"><a class="reference internal" href="#deleting-exam">Deleting <code class="docutils literal notranslate"><span class="pre">Exam</span></code>…</a></li>
<li class="toctree-l3"><a class="reference internal" href="#deleting-exam-by-events">Deleting <code class="docutils literal notranslate"><span class="pre">Exam</span></code> by events…</a></li>
<li class="toctree-l3"><a class="reference internal" href="#why-not-to-implement-get-operations-as-commands">Why not to implement <code class="docutils literal notranslate"><span class="pre">get</span></code> operations as commands?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="query.html">Exposing Information: Query Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="saga.html">Building Interactions: Sagas</a></li>
<li class="toctree-l2"><a class="reference internal" href="testing.html">Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="deployment.html">Deployment</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../architecture/_toc.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Minos Documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="_toc.html">QuickStart</a> &raquo;</li>
        
      <li>Exposing Operations: Command Service</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/quickstart/command.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="exposing-operations-command-service">
<h1>Exposing Operations: Command Service<a class="headerlink" href="#exposing-operations-command-service" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>After being learned how to setup a <code class="docutils literal notranslate"><span class="pre">minos</span></code> microservice and knowing the <code class="docutils literal notranslate"><span class="pre">Aggregate</span></code> basics and being able to start working on the domain model, the next step is to expose the implemented functionality outside, to be used both by another microservices and external clients! One of the main advantages of using <code class="docutils literal notranslate"><span class="pre">minos</span></code> is that it is able to expose endpoints over different interfaces transparently, so that the infrastructure details (that in many cases require a big effort) are handled by the framework and the business logic becomes into the leading actor of the microservice.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">minos</span></code> framework is based on the <a class="reference external" href="https://martinfowler.com/bliki/CQRS.html">CQRS</a> pattern, which is characterised by the partition of the system into two main parts: the one focused into <code class="docutils literal notranslate"><span class="pre">Command</span></code> processing and the one focused into <code class="docutils literal notranslate"><span class="pre">Query</span></code> resolving. Following the event driven ideas, the <code class="docutils literal notranslate"><span class="pre">CommandService</span></code> is the one who processes requests that modify the internal state of the microservice, with changes on the <code class="docutils literal notranslate"><span class="pre">Aggregate</span></code>, that generate events, that can be handled by the <code class="docutils literal notranslate"><span class="pre">QueryService</span></code>, who updates its own query-oriented database. Then, the requests that will not change the state of the microservice (so that, the ones that are read-only) should be resolved by the <code class="docutils literal notranslate"><span class="pre">QueryService</span></code> who asks its own database.</p>
<p>The rest of the section is focused into the <code class="docutils literal notranslate"><span class="pre">CommandService</span></code> and the basic syntax to expose endpoints. Next, the <a class="reference internal" href="query.html"><span class="doc">Exposing Information: Query Service</span></a> guide is fully focused into the <code class="docutils literal notranslate"><span class="pre">QueryService</span></code> and how to read and update the user-defined query database.</p>
</div>
<div class="section" id="setting-up-the-service">
<h2>Setting up the service!<a class="headerlink" href="#setting-up-the-service" title="Permalink to this headline">¶</a></h2>
<p>The setup process of the services is mostly equivalent both for the <code class="docutils literal notranslate"><span class="pre">CommandService</span></code> and the <code class="docutils literal notranslate"><span class="pre">QueryService</span></code> as they share the same interfaces configuration. Currently, the currently supported ones are the <em>HTTP REST</em> and the <em>Kafka</em>‘s broker, but there are plans to increase the list with <em>gRPC</em>, <em>RabbitMQ</em>, etc.</p>
<p>The second important part in the configuration file is the <code class="docutils literal notranslate"><span class="pre">commands</span></code> and <code class="docutils literal notranslate"><span class="pre">queries</span></code>, in which the <code class="docutils literal notranslate"><span class="pre">CommandService</span></code> an <code class="docutils literal notranslate"><span class="pre">QueryService</span></code> classes are being setup.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># config.yml</span>

<span class="nt">rest</span><span class="p">:</span>
  <span class="nt">host</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.0.0.0</span>
  <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8082</span>
<span class="nt">broker</span><span class="p">:</span>
  <span class="nt">host</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
  <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">9092</span>
  <span class="nt">queue</span><span class="p">:</span>
    <span class="nt">database</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">exam_db</span>
    <span class="nt">user</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">minos</span>
    <span class="nt">password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">min0s</span>
    <span class="nt">host</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
    <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5432</span>
    <span class="nt">records</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1000</span>
    <span class="nt">retry</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="nt">commands</span><span class="p">:</span>
  <span class="nt">service</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">src.commands.ExamCommandService</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>After being set up the services’ configuration, the next part is to start writing the code itself! In this case, the command service is defined into the <code class="docutils literal notranslate"><span class="pre">src/commands.py</span></code> file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">minos.cqrs</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CommandService</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">ExamCommandService</span><span class="p">(</span><span class="n">CommandService</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>The most important part here is the <code class="docutils literal notranslate"><span class="pre">minos.cqrs.CommandService</span></code> import. In <code class="docutils literal notranslate"><span class="pre">minos</span></code>, the <code class="docutils literal notranslate"><span class="pre">cqrs</span></code> module is the one who implements the abstract service classes, both for commands and for queries.</p>
<p>Another important part is how to expose and set up the endpoints. In this case, <code class="docutils literal notranslate"><span class="pre">minos.networks</span></code> provides the <code class="docutils literal notranslate"><span class="pre">&#64;enroute</span></code> decorator, that can be seen as a hierarchical decorator composed by the following parts:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;enroute.rest.command(url,</span> <span class="pre">method)</span></code>: Exposes a <em>Command</em> request over the <em>REST</em> interface.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;enroute.rest.query(url,</span> <span class="pre">method)</span></code>: Exposes a <em>Query</em> request over the <em>REST</em> interface.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;enroute.broker.command(topic)</span></code>:Exposes a <em>Command</em> request over the <em>Broker</em> interface.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;enroute.broker.query(topic)</span></code>:Exposes a <em>Query</em> request over the <em>Broker</em> interface.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;enroute.broker.event(topic)</span></code>: Exposes an <em>Event</em> request over the <em>Broker</em> interface.</p></li>
</ul>
<p>After being learnt how to setup the services on the configuration file and take an overview over the <code class="docutils literal notranslate"><span class="pre">CommandService</span></code> base class and the <code class="docutils literal notranslate"><span class="pre">&#64;enroute</span></code> decorator, it’s time to introduce the expected function’s prototype for each exposed endpoint:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">minos.networks</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Request</span><span class="p">,</span>
    <span class="n">Response</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">class</span> <span class="nc">MyService</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>

    <span class="nd">@enroute</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="nd">@enroute</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">make_foo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Response</span><span class="p">]:</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">minos.networks.Request</span></code> and <code class="docutils literal notranslate"><span class="pre">minos.networks.Response</span></code> are the classes with the responsibility to provide access to the received request itself and to build the given response. The main advantage of these two classes are that they are able to fully isolate the surrounding network interface that received the request, so that the code keeps much more simple. One thing to notice is that the endpoint does not need to necessarily return any value because there are some cases in which has no sense from the business logic perspective. Also, it’s important to notice that the <code class="docutils literal notranslate"><span class="pre">minos.networks.ResponseException</span></code> provides a way to notify that there was some kind of situation that does not allow resolve the request successfully.</p>
<p>Now that the basic concepts to expose operations that can be used both by another microservices and also by external clients, the next step is to include some examples that help in the process to understand it better.</p>
</div>
<div class="section" id="exposing-exam-creation">
<h2>Exposing <code class="docutils literal notranslate"><span class="pre">Exam</span></code> creation…<a class="headerlink" href="#exposing-exam-creation" title="Permalink to this headline">¶</a></h2>
<p>A common operation on a microservice is the creation of <code class="docutils literal notranslate"><span class="pre">Aggregate</span></code> instances. Here is an example of <code class="docutils literal notranslate"><span class="pre">Exam</span></code>‘s creation, defined on the <code class="docutils literal notranslate"><span class="pre">ExamCommandService</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">minos.common</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">EntitySet</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">minos.networks</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">enroute</span><span class="p">,</span>
    <span class="n">Response</span><span class="p">,</span>
    <span class="n">Request</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.aggregates</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Exam</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">ExamCommandService</span><span class="p">(</span><span class="n">CommandService</span><span class="p">):</span>

    <span class="nd">@enroute</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;/exams&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">)</span>
    <span class="nd">@enroute</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;CreateExam&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">create_exam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">content</span><span class="p">()</span>

        <span class="n">exam</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Exam</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="s2">&quot;subject&quot;</span><span class="p">],</span> <span class="n">content</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">],</span> <span class="n">EntitySet</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">exam</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
</pre></div>
</div>
<p>In this case, the command is exposed both over the <em>REST</em> and <em>Broker</em> interfaces. The way to extract the information from a <code class="docutils literal notranslate"><span class="pre">Request</span></code> instance is through its <code class="docutils literal notranslate"><span class="pre">content()</span></code> method, that in this case is assumed to be a <code class="docutils literal notranslate"><span class="pre">dict</span></code> instance containing the <code class="docutils literal notranslate"><span class="pre">subject</span></code> and <code class="docutils literal notranslate"><span class="pre">title</span></code> fields. The <code class="docutils literal notranslate"><span class="pre">return</span></code> value in this case is a <code class="docutils literal notranslate"><span class="pre">Response</span></code> instance, in which the content is composed of an <code class="docutils literal notranslate"><span class="pre">UUID</span></code> instance, but another composed options would have been possible. To know more about that, it’s recommended to visit [TODO: link to Request/Response architecture section].</p>
</div>
<div class="section" id="adding-exam-questions">
<h2>Adding <code class="docutils literal notranslate"><span class="pre">Exam</span></code> questions!<a class="headerlink" href="#adding-exam-questions" title="Permalink to this headline">¶</a></h2>
<p>Similarly to <code class="docutils literal notranslate"><span class="pre">Exam</span></code>‘s creation, another possible command could be the question adding:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">minos.common</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ValueObjectSet</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.aggregates</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Question</span><span class="p">,</span>
    <span class="n">Answer</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">ExamCommandService</span><span class="p">(</span><span class="n">CommandService</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="nd">@enroute</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;/exams/</span><span class="si">{uuid}</span><span class="s2">/questions&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">)</span>
    <span class="nd">@enroute</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;AddExamQuestion&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">add_question</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">content</span><span class="p">()</span>

        <span class="n">exam</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Exam</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="s2">&quot;exam&quot;</span><span class="p">])</span>
        <span class="n">answers</span> <span class="o">=</span> <span class="n">ValueObjectSet</span><span class="p">([</span><span class="n">Answer</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">],</span> <span class="n">raw</span><span class="p">[</span><span class="s2">&quot;correct&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">content</span><span class="p">[</span><span class="s2">&quot;answer&quot;</span><span class="p">]])</span>
        <span class="n">question</span> <span class="o">=</span> <span class="n">Question</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">],</span> <span class="n">answers</span><span class="p">)</span>
        <span class="n">exam</span><span class="o">.</span><span class="n">questions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">exam</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">question</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
</pre></div>
</div>
<p>As it can be seeing, the main structure of the handling method is really similar to the one for <code class="docutils literal notranslate"><span class="pre">Exam</span></code>‘s creation. An interesting difference here is that the generated <code class="docutils literal notranslate"><span class="pre">ExamUpdated</span></code> event will contain only the <code class="docutils literal notranslate"><span class="pre">Question</span></code> instance that is being created as it is stored inside an <code class="docutils literal notranslate"><span class="pre">EntitySet</span></code>. This is really important from the <code class="docutils literal notranslate"><span class="pre">QueryService</span></code> perspective, as it will be seeing in future guides.</p>
</div>
<div class="section" id="deleting-exam">
<h2>Deleting <code class="docutils literal notranslate"><span class="pre">Exam</span></code>…<a class="headerlink" href="#deleting-exam" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">Exam</span></code>‘s deletion could be another common use case on a <code class="docutils literal notranslate"><span class="pre">exam</span></code> microservice. It can be implemented with a handling method like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">minos.common</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">MinosSnapshotAggregateNotFoundException</span><span class="p">,</span>
    <span class="n">MinosSnapshotDeletedAggregateException</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">minos.networks</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ResponseException</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">ExamCommandService</span><span class="p">(</span><span class="n">CommandService</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="nd">@enroute</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;/exams/</span><span class="si">{uuid}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">)</span>
    <span class="nd">@enroute</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;DeleteExam&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">delete_exam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">content</span><span class="p">()</span>
        <span class="n">uuid</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">exam</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Exam</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">MinosSnapshotAggregateNotFoundException</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ResponseException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The exam does not exists: </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">MinosSnapshotDeletedAggregateException</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ResponseException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The exam is already deleted: </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">exam</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</pre></div>
</div>
<p>The interesting part of this handling method is that it does not return any <code class="docutils literal notranslate"><span class="pre">Response</span></code>, which is a valid implementation, but it raises a <code class="docutils literal notranslate"><span class="pre">ResponseException</span></code> to notify the caller about the reason why the deletion could not be performed.</p>
</div>
<div class="section" id="deleting-exam-by-events">
<h2>Deleting <code class="docutils literal notranslate"><span class="pre">Exam</span></code> by events…<a class="headerlink" href="#deleting-exam-by-events" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">Exam</span></code> aggregate contains a <code class="docutils literal notranslate"><span class="pre">ModelRef</span></code> to an external <code class="docutils literal notranslate"><span class="pre">Subject</span></code> aggregate, that it’s assumed that is defined into another microservice. In classic monolithic systems that uses relational database schemas, a <code class="docutils literal notranslate"><span class="pre">ON</span> <span class="pre">DELETE</span></code> statement defines how instances with references will behave after a deletion of the referred instance. As <code class="docutils literal notranslate"><span class="pre">minos</span></code> follows the event driven ideas, it’s also possible to perform operations after an event is published. So, a common use case of that could be to implement the <code class="docutils literal notranslate"><span class="pre">ON</span> <span class="pre">DELETE</span> <span class="pre">CASCADE</span></code> strategy between <code class="docutils literal notranslate"><span class="pre">Exam</span></code> and <code class="docutils literal notranslate"><span class="pre">Subject</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">minos.common</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Condition</span><span class="p">,</span>
    <span class="n">MinosSnapshotAggregateNotFoundException</span><span class="p">,</span>
    <span class="n">MinosSnapshotDeletedAggregateException</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">minos.networks</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ResponseException</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">ExamCommandService</span><span class="p">(</span><span class="n">CommandService</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="nd">@enroute</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="s2">&quot;SubjectDeleted&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">delete_exam_by_subject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">content</span><span class="p">()</span>

        <span class="n">exams</span> <span class="o">=</span> <span class="p">{</span><span class="n">exam</span> <span class="k">async</span> <span class="k">for</span> <span class="n">exam</span> <span class="ow">in</span> <span class="k">await</span> <span class="n">Exam</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">Condition</span><span class="p">(</span><span class="s2">&quot;subject&quot;</span><span class="p">,</span> <span class="n">content</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]))}</span>

        <span class="k">for</span> <span class="n">exam</span> <span class="ow">in</span> <span class="n">exams</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">exam</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</pre></div>
</div>
<p>One of the main advantages of an event based implementation is that it’s very easy to understand and implement. Also, it keeps the dependencies on the right direction and improves isolation of each component in the system. [TODO: Tell the saga based alternative.]</p>
</div>
<div class="section" id="why-not-to-implement-get-operations-as-commands">
<h2>Why not to implement <code class="docutils literal notranslate"><span class="pre">get</span></code> operations as commands?<a class="headerlink" href="#why-not-to-implement-get-operations-as-commands" title="Permalink to this headline">¶</a></h2>
<p>The queries (or get operations) are a special kind of operations characterised by the absence of side effects. As the <code class="docutils literal notranslate"><span class="pre">minos</span></code> framework follow the <a class="reference external" href="https://martinfowler.com/bliki/CQRS.html">CQRS</a> pattern, it is highly recommended not to implement <code class="docutils literal notranslate"><span class="pre">get</span></code> operations to be resolved by the <code class="docutils literal notranslate"><span class="pre">CommandService</span></code> because its responsibility must be to define operations that change the internal <code class="docutils literal notranslate"><span class="pre">Aggregate</span></code> instances in some sense.</p>
<p>By cons, the <code class="docutils literal notranslate"><span class="pre">QueryService</span></code> must not use the <code class="docutils literal notranslate"><span class="pre">Aggregate</span></code> class directly, so it cannot change its state, but it’s able to know that state through the domain events given as <code class="docutils literal notranslate"><span class="pre">AggregateDiff</span></code> instances. In this way, the <code class="docutils literal notranslate"><span class="pre">QueryService</span></code> is able to have a custom internal representation of the <code class="docutils literal notranslate"><span class="pre">Aggregate</span></code> oriented to the queries that it implements, being easier to have big performance advantages. A more detailed explanation can be seen in <a class="reference internal" href="query.html"><span class="doc">Exposing Information: Query Service</span></a>.</p>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>After being described step by step the main features of the <code class="docutils literal notranslate"><span class="pre">minos.cqrs.CommandService</span></code> class and related classes like <code class="docutils literal notranslate"><span class="pre">minos.networks.Request</span></code>, <code class="docutils literal notranslate"><span class="pre">minos.networks.Response</span></code> and <code class="docutils literal notranslate"><span class="pre">minos.networks.enroute</span></code>, here is a full snapshot of the resulting <code class="docutils literal notranslate"><span class="pre">src/commands.py</span></code> file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;src/commands.py&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">minos.common</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Condition</span><span class="p">,</span>
    <span class="n">EntitySet</span><span class="p">,</span>
    <span class="n">ValueObjectSet</span><span class="p">,</span>
    <span class="n">MinosSnapshotAggregateNotFoundException</span><span class="p">,</span>
    <span class="n">MinosSnapshotDeletedAggregateException</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">minos.cqrs</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CommandService</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">minos.networks</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Request</span><span class="p">,</span>
    <span class="n">Response</span><span class="p">,</span>
    <span class="n">ResponseException</span><span class="p">,</span>
    <span class="n">enroute</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">.aggregates</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Exam</span><span class="p">,</span>
    <span class="n">Question</span><span class="p">,</span>
    <span class="n">Answer</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">ExamCommandService</span><span class="p">(</span><span class="n">CommandService</span><span class="p">):</span>

    <span class="nd">@enroute</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;/exams&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">)</span>
    <span class="nd">@enroute</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;CreateExam&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">create_exam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">content</span><span class="p">()</span>

        <span class="n">exam</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Exam</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">content</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">],</span> <span class="n">content</span><span class="p">[</span><span class="s2">&quot;subject&quot;</span><span class="p">],</span> <span class="n">EntitySet</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">exam</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>

    <span class="nd">@enroute</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;/exams/</span><span class="si">{uuid}</span><span class="s2">/questions&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">)</span>
    <span class="nd">@enroute</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;AddExamQuestion&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">add_question</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">content</span><span class="p">()</span>

        <span class="n">exam</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Exam</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="s2">&quot;exam&quot;</span><span class="p">])</span>
        <span class="n">answers</span> <span class="o">=</span> <span class="n">ValueObjectSet</span><span class="p">([</span><span class="n">Answer</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span> <span class="n">raw</span><span class="p">[</span><span class="s2">&quot;correct&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">content</span><span class="p">[</span><span class="s2">&quot;answer&quot;</span><span class="p">]])</span>
        <span class="n">question</span> <span class="o">=</span> <span class="n">Question</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">],</span> <span class="n">answers</span><span class="p">)</span>
        <span class="n">exam</span><span class="o">.</span><span class="n">questions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">exam</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">question</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>

    <span class="nd">@enroute</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;/exams&quot;</span><span class="p">,</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">)</span>
    <span class="nd">@enroute</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;DeleteExam&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">delete_exam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">content</span><span class="p">()</span>
        <span class="n">uuid</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">exam</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Exam</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">MinosSnapshotAggregateNotFoundException</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ResponseException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The exam does not exists: </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">MinosSnapshotDeletedAggregateException</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ResponseException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The exam is already deleted: </span><span class="si">{</span><span class="n">uuid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">exam</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

    <span class="nd">@enroute</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="s2">&quot;SubjectDeleted&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">delete_exam_by_subject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">content</span><span class="p">()</span>

        <span class="n">exams</span> <span class="o">=</span> <span class="p">{</span><span class="n">exam</span> <span class="k">async</span> <span class="k">for</span> <span class="n">exam</span> <span class="ow">in</span> <span class="k">await</span> <span class="n">Exam</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">Condition</span><span class="p">(</span><span class="s2">&quot;subject&quot;</span><span class="p">,</span> <span class="n">content</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]))}</span>

        <span class="k">for</span> <span class="n">exam</span> <span class="ow">in</span> <span class="n">exams</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">exam</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="query.html" class="btn btn-neutral float-right" title="Exposing Information: Query Service" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="aggregate.html" class="btn btn-neutral float-left" title="Modeling the Domain: Aggregates" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Clariteia.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>
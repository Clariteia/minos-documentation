

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Modeling the Domain: Aggregates &mdash; Minos Documentation  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Exposing Operations: Command Service" href="command.html" />
    <link rel="prev" title="Setup" href="setup.html" />
    <link href="../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Minos Documentation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="_toc.html">QuickStart</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="setup.html">Setup</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Modeling the Domain: Aggregates</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#defining-the-exam-aggregate">Defining the <code class="docutils literal notranslate"><span class="pre">Exam</span></code> aggregate…</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#storage-operations">Storage Operations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#field-parsing">Field Parsing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#field-validation">Field Validation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#defining-the-subject-reference">Defining the <code class="docutils literal notranslate"><span class="pre">Subject</span></code> reference…</a></li>
<li class="toctree-l3"><a class="reference internal" href="#defining-the-question-entity">Defining the <code class="docutils literal notranslate"><span class="pre">Question</span></code> entity…</a></li>
<li class="toctree-l3"><a class="reference internal" href="#defining-the-choice-value-object">Defining the <code class="docutils literal notranslate"><span class="pre">Choice</span></code> value object…</a></li>
<li class="toctree-l3"><a class="reference internal" href="#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="command.html">Exposing Operations: Command Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="query.html">Exposing Information: Query Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="saga.html">Building Interactions: Sagas</a></li>
<li class="toctree-l2"><a class="reference internal" href="testing.html">Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="deployment.html">Deployment</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../architecture/_toc.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Minos Documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="_toc.html">QuickStart</a> &raquo;</li>
        
      <li>Modeling the Domain: Aggregates</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/quickstart/aggregate.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="modeling-the-domain-aggregates">
<h1>Modeling the Domain: Aggregates<a class="headerlink" href="#modeling-the-domain-aggregates" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>In opposite to monolithic systems who use relational database model to represent and store the business logic, microservice-based systems requires applying slightly different techniques. One of the main reasons to start thinking different is based on the splitting of a single but big information schema into multiple smaller ones, as each microservice has its own dedicated database.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">minos</span></code> proposal is based on the <em>Domain Drive Design (DDD)</em> ideas, supported by <em>Entities</em>, <em>Value-Objects</em> and an <em>Aggregate</em> (or <em>Root Entity</em>) that represents the main concept of the microservice. These set of concepts allows us to model information at microservice level, but at some cases it’s needed to relate information from one microservice with information from another one. The way to do that in <code class="docutils literal notranslate"><span class="pre">minos</span></code> is over <em>Aggregate References</em>. To understand these concepts in more detail, the <a class="reference internal" href="../architecture/data_model.html"><span class="doc">Data Model</span></a> section provides a more detailed explanation about them.</p>
</div>
<div class="section" id="defining-the-exam-aggregate">
<h2>Defining the <code class="docutils literal notranslate"><span class="pre">Exam</span></code> aggregate…<a class="headerlink" href="#defining-the-exam-aggregate" title="Permalink to this headline">¶</a></h2>
<p>As it is advanced at the beginning of the <a class="reference internal" href="_toc.html"><span class="doc">QuickStart</span></a> guide, the study case will be to define an <code class="docutils literal notranslate"><span class="pre">exam</span></code> microservice. This one will be able to store all the needed information related with a common <em>exam</em> composed of questions with selectable answers. For sake of simplicity, all of them must be multiple answer questions, but it’s a good practising exercise to continue working on these case and add another functionalities.</p>
<p>In this case, the <code class="docutils literal notranslate"><span class="pre">Exam</span></code> class will be the root-entity or <code class="docutils literal notranslate"><span class="pre">Aggregate</span></code> of the microservice, so that most of the operations sent to it will be related with the <code class="docutils literal notranslate"><span class="pre">Exam</span></code>. In <code class="docutils literal notranslate"><span class="pre">minos</span></code>, the way to do that is to inherit from the <code class="docutils literal notranslate"><span class="pre">minos.common.Aggregate</span></code> class, that is similar to <code class="docutils literal notranslate"><span class="pre">Python</span></code>‘s <a class="reference external" href="https://docs.python.org/3/library/dataclasses.html">dataclasses</a> in the sense that is able to build the class fields based on the typing. The currently supported types are all the simple <code class="docutils literal notranslate"><span class="pre">Python</span></code>‘s types (<code class="docutils literal notranslate"><span class="pre">int</span></code>, <code class="docutils literal notranslate"><span class="pre">float</span></code>, <code class="docutils literal notranslate"><span class="pre">str</span></code>, …) but also another advanced types are supported, like <code class="docutils literal notranslate"><span class="pre">list</span></code>, <code class="docutils literal notranslate"><span class="pre">dict</span></code>, <code class="docutils literal notranslate"><span class="pre">datetime</span></code>, etc. See the full documentation to obtain a detailed description.</p>
<p>With this simple functionality, it’s already possible to start building the <code class="docutils literal notranslate"><span class="pre">Exam</span></code> structure, or at least defining the fields based on simpler types, as it can be seen here:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">timedelta</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">minos.common</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Aggregate</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">Exam</span><span class="p">(</span><span class="n">Aggregate</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">duration</span><span class="p">:</span> <span class="n">timedelta</span>
    <span class="c1"># subject: ...</span>
    <span class="c1"># questions: ...</span>
</pre></div>
</div>
<p>Then, an exam instance could be created as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Exam</span><span class="p">(</span><span class="s2">&quot;Mid-term&quot;</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">))</span>
</pre></div>
</div>
<p>One important thing to notice is that the <code class="docutils literal notranslate"><span class="pre">Aggregate</span></code> class also provides another additional fields related both with the identification and versioning that must not be provided by the developer (they are computed internally). The concrete fields are the following:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">uuid:</span> <span class="pre">UUID</span></code> Unique identifier of the instance.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">version:</span> <span class="pre">int</span></code> Version of the instance, computed as an auto-incremental integer starting from <code class="docutils literal notranslate"><span class="pre">1</span></code> during the creation process.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">created_at:</span> <span class="pre">datetime</span></code> Creation timestamp of the instance.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">updated_at:</span> <span class="pre">datetime</span></code> Timestamp of the last update of the instance.</p></li>
</ul>
<p>But the real potential of the <code class="docutils literal notranslate"><span class="pre">Aggregate</span></code> class starts being visible when storage operations are performed:</p>
<div class="section" id="storage-operations">
<h3>Storage Operations<a class="headerlink" href="#storage-operations" title="Permalink to this headline">¶</a></h3>
<p>Before starting to describe the available <em>CRUD</em> operations provided by the <code class="docutils literal notranslate"><span class="pre">Aggregate</span></code> class, it’s important to notice one important part of the <code class="docutils literal notranslate"><span class="pre">minos</span></code> framework and how those operations are implemented. The nature of the framework is highly inspired by <em>Event Sourcing</em> thoughts, so that the aggregate is not simply stored on a collection that is being updated progressively without taking history into account, but the aggregate is stored as a sequence of incremental modifications known as <code class="docutils literal notranslate"><span class="pre">AggregateDiff</span></code> entries that acts as <em>Domain Events</em>.</p>
<p>This set of events are stored on a <em>Repository</em> who is defined by the <code class="docutils literal notranslate"><span class="pre">minos.common.MinosRepository</span></code> interface, but also are exposed to another microservices over a <em>Broker</em>, who is defined by the <code class="docutils literal notranslate"><span class="pre">minos.common.MinosBroker</span></code> interface. The event based strategy has an important caveat, that is how to access the full aggregate as most business logic operations will probably require working with a full <code class="docutils literal notranslate"><span class="pre">Exam</span></code> instance (not only with the sequence of <code class="docutils literal notranslate"><span class="pre">AggregateDiff</span></code> instances). As the reconstruction each time a full instance is needed is a really inefficient operation, <code class="docutils literal notranslate"><span class="pre">minos</span></code> holds on a <em>Snapshot</em> who is defined by the <code class="docutils literal notranslate"><span class="pre">minos.common.MinosSnapshot</span></code> interface and provided direct access to the reconstructed instances. To know more about how <em>Event Sourcing</em> is implemented in <code class="docutils literal notranslate"><span class="pre">minos</span></code>, the [TODO: link to architecture] sections provides a detailed description.</p>
<p>The configuration file <code class="docutils literal notranslate"><span class="pre">service.injections</span></code> section of the configuration file allows to setup both the <code class="docutils literal notranslate"><span class="pre">reposiory</span></code>, <code class="docutils literal notranslate"><span class="pre">event_broker</span></code> and <code class="docutils literal notranslate"><span class="pre">snapshot</span></code> concrete classes:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># config.yml</span>

<span class="nt">service</span><span class="p">:</span>
  <span class="nt">injections</span><span class="p">:</span>
    <span class="nt">event_broker</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">minos.networks.EventBroker</span>
    <span class="nt">repository</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">minos.common.PostgreSqlRepository</span>
    <span class="nt">snapshot</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">minos.common.PostgreSqlSnapshot</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>After being introduced how aggregate persistence is implemented in <code class="docutils literal notranslate"><span class="pre">minos</span></code>, the next sections provide a reference guide about how to use the storage operations step by step. One important thing to notice is that all of them are implemented using <em>awaitables</em>, so it’s needed to know the <a class="reference external" href="https://docs.python.org/3/library/asyncio.html">asyncio</a> basis to get the most of them.</p>
<div class="section" id="create">
<h4>Create<a class="headerlink" href="#create" title="Permalink to this headline">¶</a></h4>
<p>To create new aggregate instances, the best choice is to use the <code class="docutils literal notranslate"><span class="pre">create()</span></code> class method, which is similar to creating an instance directly calling the class constructor, but also stores a <em>creation event</em> into the <em>Repository</em>, so that the persistence is guaranteed. Then, the <em>Broker</em> will publish the <em>update event</em> on the <code class="docutils literal notranslate"><span class="pre">{$AGGREGATE_NAME}Created</span></code> topic. In addition to that, the retrieved instance has already set the auto-generated fields (<code class="docutils literal notranslate"><span class="pre">uuid</span></code>, <code class="docutils literal notranslate"><span class="pre">version</span></code>, etc.).</p>
<p>For example, creating an <code class="docutils literal notranslate"><span class="pre">Exam</span></code> aggregate can be done with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">exam</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Exam</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s2">&quot;Mid-term&quot;</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">exam</span></code> instance will be like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Exam</span><span class="p">(</span>
    <span class="n">uuid</span><span class="o">=...</span><span class="p">,</span> <span class="c1"># generated uuid</span>
    <span class="n">version</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">created_at</span><span class="o">=...</span><span class="p">,</span> <span class="c1"># generated datetime</span>
    <span class="n">updated_at</span><span class="o">=...</span><span class="p">,</span> <span class="c1"># generated datetime</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Mid-term&quot;</span><span class="p">,</span>
    <span class="n">duration</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>And the corresponding <em>creation event</em> will be like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">AggregateDiff</span><span class="p">(</span>
    <span class="n">action</span><span class="o">=</span><span class="n">Action</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;src.aggregates.Exam&quot;</span><span class="p">,</span>
    <span class="n">uuid</span><span class="o">=...</span><span class="p">,</span> <span class="c1"># generated aggregate uuid</span>
    <span class="n">version</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">created_at</span><span class="o">=...</span><span class="p">,</span> <span class="c1"># generated aggregate datetime</span>
    <span class="n">fields_diff</span><span class="o">=</span><span class="n">FieldDiffContainer</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Mid-term&quot;</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="update">
<h4>Update<a class="headerlink" href="#update" title="Permalink to this headline">¶</a></h4>
<p>The update operation modifies the value of some fields that are composing the aggregate. The way to do that is through the <code class="docutils literal notranslate"><span class="pre">update()</span></code> method, which get the set of values to be updated as named arguments, in which the given name matches with the corresponding field name. Internally, the method computes the fields difference between the previous and new fields and then stores an <em>update event</em> into the <em>Repository</em>, so that the persistence is guaranteed. Then, the <em>Broker</em> will publish the <em>update event</em> on the <code class="docutils literal notranslate"><span class="pre">{$AGGREGATE_NAME}Updated</span></code> topic.  In this case, also the <code class="docutils literal notranslate"><span class="pre">version</span></code> and <code class="docutils literal notranslate"><span class="pre">updated_at</span></code> fields are updated according to the new changes.</p>
<p>For example, updating the <code class="docutils literal notranslate"><span class="pre">duration</span></code> field from the previously created <code class="docutils literal notranslate"><span class="pre">Exam</span></code> aggregate can be done with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">await</span> <span class="n">exam</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">duration</span><span class="o">=</span><span class="n">exam</span><span class="o">.</span><span class="n">duration</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">))</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">exam</span></code> instance will be like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Exam</span><span class="p">(</span>
    <span class="n">uuid</span><span class="o">=...</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="c1"># updated</span>
    <span class="n">created_at</span><span class="o">=...</span><span class="p">,</span>
    <span class="n">updated_at</span><span class="o">=...</span><span class="p">,</span> <span class="c1"># updated</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Mid-term&quot;</span><span class="p">,</span>
    <span class="n">duration</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">),</span> <span class="c1"># updated</span>
<span class="p">)</span>
</pre></div>
</div>
<p>And the corresponding <em>update event</em> will be like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">AggregateDiff</span><span class="p">(</span>
    <span class="n">action</span><span class="o">=</span><span class="n">Action</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;src.aggregates.Exam&quot;</span><span class="p">,</span>
    <span class="n">uuid</span><span class="o">=...</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">created_at</span><span class="o">=...</span><span class="p">,</span> <span class="c1"># generated datetime</span>
    <span class="n">fields_diff</span><span class="o">=</span><span class="n">FieldDiffContainer</span><span class="p">(</span>
        <span class="n">duration</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Additionally, the <code class="docutils literal notranslate"><span class="pre">Aggregate</span></code> class provides a <code class="docutils literal notranslate"><span class="pre">save()</span></code> method that automatically <em>creates</em> or <em>updates</em> the instance depending on if it’s a new one or an already exising. Here is an example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">exam</span> <span class="o">=</span> <span class="n">Exam</span><span class="p">(</span><span class="s2">&quot;Mid-term&quot;</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="k">await</span> <span class="n">exam</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="n">exam</span><span class="o">.</span><span class="n">duration</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="k">await</span> <span class="n">exam</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="delete">
<h4>Delete<a class="headerlink" href="#delete" title="Permalink to this headline">¶</a></h4>
<p>After being explained who to create and update instances, the remaining operation is the deletion one. In the <code class="docutils literal notranslate"><span class="pre">minos</span></code> framework it’s implemented with a <code class="docutils literal notranslate"><span class="pre">delete</span></code> method, that internally stores a <em>deletion event</em> in to the <em>Repository</em> so that the persistence is guaranteed. Then, the <em>Broker</em> will publish the <em>update event</em> on the <code class="docutils literal notranslate"><span class="pre">{$AGGREGATE_NAME}Deleted</span></code> topic.</p>
<p>For example, deleting an instance can be done with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">await</span> <span class="n">exam</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</pre></div>
</div>
<p>In this case, does not make any sense to continue working with the <code class="docutils literal notranslate"><span class="pre">exam</span></code> instance anymore, but the corresponding <em>delete event</em> will be like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">AggregateDiff</span><span class="p">(</span>
    <span class="n">action</span><span class="o">=</span><span class="n">Action</span><span class="o">.</span><span class="n">DELETE</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;src.aggregates.Exam&quot;</span><span class="p">,</span>
    <span class="n">uuid</span><span class="o">=...</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">created_at</span><span class="o">=...</span><span class="p">,</span> <span class="c1"># generated datetime</span>
    <span class="n">fields_diff</span><span class="o">=</span><span class="n">FieldDiffContainer</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
<p>One important thing to notice is that the <code class="docutils literal notranslate"><span class="pre">create</span></code>, <code class="docutils literal notranslate"><span class="pre">update</span></code> and <code class="docutils literal notranslate"><span class="pre">delete</span></code> operations are writing operations, so all of them generates some kind of event to be stored internally and notified to others so that these operations requires to use the <em>Repository</em> and <em>Broker</em> components. However, the following operations (<code class="docutils literal notranslate"><span class="pre">get</span></code> and <code class="docutils literal notranslate"><span class="pre">find</span></code>) are reading operations, so the execution of them does not generate any events. Also, as it will be explained later, these operations are related with <code class="docutils literal notranslate"><span class="pre">Aggregate</span></code> instances, so it’s needed to use the <em>Snapshot</em> component, whose purpose is to provide a simple and efficient way to access them.</p>
</div>
<div class="section" id="get">
<h4>Get<a class="headerlink" href="#get" title="Permalink to this headline">¶</a></h4>
<p>The way to obtain an instance based on its identifier is calling the <code class="docutils literal notranslate"><span class="pre">get</span></code> class method, which returns a single one, failing if it does not exist or is already deleted. In this case, the <em>Snapshot</em> guarantees a strong consistency respect to the <em>Repository</em> of events.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">original</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Exam</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="n">identifier</span> <span class="o">=</span> <span class="n">original</span><span class="o">.</span><span class="n">uuid</span>

<span class="n">recovered</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Exam</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">original</span> <span class="o">==</span> <span class="n">recovered</span>
</pre></div>
</div>
<p>As the <code class="docutils literal notranslate"><span class="pre">get</span></code> class method only retrieves one instance at a time, a good option to retrieve multiple instances concurrently, together with the validation checks (existence and not already deletion) is to use <code class="docutils literal notranslate"><span class="pre">asyncio</span></code>‘s <code class="docutils literal notranslate"><span class="pre">gather</span></code> function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">asyncio</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">gather</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">uuids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">UUID</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span>

<span class="n">exams</span> <span class="o">=</span> <span class="k">await</span> <span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">Exam</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span> <span class="k">for</span> <span class="n">uuid</span> <span class="ow">in</span> <span class="n">uuids</span><span class="p">))</span>
</pre></div>
</div>
<p>If the validation checks are not needed, or can be performed directly at application level, a better option is to use the <code class="docutils literal notranslate"><span class="pre">find</span></code> class method.</p>
</div>
<div class="section" id="find">
<h4>Find<a class="headerlink" href="#find" title="Permalink to this headline">¶</a></h4>
<p>Previously described operations have one important thing in common, that is all of them need to know the exact aggregate instance to work with, in other words, all of them needed to know the exact identifier of the instance. Is true that in many cases, this is enough to resolve many use cases, but there are some situations in which a more advanced search is needed. A common example is when it’s needed to apply operations to a set of instances characterised by special conditions and so on.</p>
<p>The way to perform this kind of queries is with the <code class="docutils literal notranslate"><span class="pre">find</span></code> class method, which not only filters instances according to a given <code class="docutils literal notranslate"><span class="pre">Condition</span></code>, but can also return them with some specific <code class="docutils literal notranslate"><span class="pre">Ordering</span></code> and <code class="docutils literal notranslate"><span class="pre">limit</span></code> the maximum number of instances. For more details about how to write complex queries is highly recommended reading the <a class="reference external" href="https://clariteia.github.io/minos_microservice_common/api/minos.common.queries.html">minos.common.queries</a> reference documentation. Another thing to know about the <code class="docutils literal notranslate"><span class="pre">find</span></code> class method is that it returns the obtained instances over an <code class="docutils literal notranslate"><span class="pre">AsyncIterator</span></code> and supports a streaming mode directly from the database if the <code class="docutils literal notranslate"><span class="pre">streaming_mode</span></code> flag is set to <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p>
<p>Here is an example of a relatively complex <code class="docutils literal notranslate"><span class="pre">find</span></code> operation, that will return a ranking of <code class="docutils literal notranslate"><span class="pre">&quot;Mid-term&quot;</span></code> exams with more duration created during the last week:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">date</span><span class="p">,</span>
    <span class="n">timedelta</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">minos.common</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Condition</span><span class="p">,</span>
    <span class="n">Ordering</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">condition</span> <span class="o">=</span> <span class="n">Condition</span><span class="o">.</span><span class="n">AND</span><span class="p">(</span>
    <span class="n">Condition</span><span class="o">.</span><span class="n">GREATED_EQUAL</span><span class="p">(</span><span class="s2">&quot;created_at&quot;</span><span class="p">,</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)),</span>
    <span class="n">Condition</span><span class="o">.</span><span class="n">EQUAL</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;Mid-term&quot;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">ordering</span> <span class="o">=</span> <span class="n">Ordering</span><span class="o">.</span><span class="n">DESC</span><span class="p">(</span><span class="s2">&quot;duration&quot;</span><span class="p">)</span>

<span class="k">async</span> <span class="k">for</span> <span class="n">exam</span> <span class="ow">in</span> <span class="n">Exam</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">ordering</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">exam</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="field-parsing">
<h3>Field Parsing<a class="headerlink" href="#field-parsing" title="Permalink to this headline">¶</a></h3>
<p>There are some specific cases in which the fields should be transformed according to specific rules before setting them into the aggregate instances. To do that, <code class="docutils literal notranslate"><span class="pre">minos</span></code> is able to automatically recognizes the methods that matches the <code class="docutils literal notranslate"><span class="pre">parse_${FIELD_NAME}(value:</span> <span class="pre">Any)</span> <span class="pre">-&gt;</span> <span class="pre">Any</span></code> and triggers them before setting the corresponding values.</p>
<p>For example, a parsing method can be used to capitalize the <code class="docutils literal notranslate"><span class="pre">Exam</span></code>‘s name:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Exam</span><span class="p">(</span><span class="n">Aggregate</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">parse_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="field-validation">
<h3>Field Validation<a class="headerlink" href="#field-validation" title="Permalink to this headline">¶</a></h3>
<p>Similar to field parsing, <code class="docutils literal notranslate"><span class="pre">minos</span></code> provides also the capabilities to implement custom validation methods if type checking is not enough. Concretely, the framework automatically recognizes the methods that matches the <code class="docutils literal notranslate"><span class="pre">validate_${FIELD_NAME}(value:</span> <span class="pre">Any)</span> <span class="pre">-&gt;</span> <span class="pre">bool</span></code> and triggers them before setting the corresponding values. If the validation result is evaluated to <code class="docutils literal notranslate"><span class="pre">False</span></code>, then a validation exception is raised and the value is not set.</p>
<p>For example, a validation function can be used to require that <code class="docutils literal notranslate"><span class="pre">Exam</span></code>‘s name have at least three characters.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Exam</span><span class="p">(</span><span class="n">Aggregate</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">validate_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="defining-the-subject-reference">
<h2>Defining the <code class="docutils literal notranslate"><span class="pre">Subject</span></code> reference…<a class="headerlink" href="#defining-the-subject-reference" title="Permalink to this headline">¶</a></h2>
<p>TODO</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">minos.common</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">AggregateRef</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">Subject</span><span class="p">(</span><span class="n">AggregateRef</span><span class="p">):</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
</pre></div>
</div>
</div>
<div class="section" id="defining-the-question-entity">
<h2>Defining the <code class="docutils literal notranslate"><span class="pre">Question</span></code> entity…<a class="headerlink" href="#defining-the-question-entity" title="Permalink to this headline">¶</a></h2>
<p>TODO</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">minos.common</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Entity</span><span class="p">,</span>
    <span class="n">ValueObjectSet</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">class</span> <span class="nc">Question</span><span class="p">(</span><span class="n">Entity</span><span class="p">):</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># choices: ...</span>
</pre></div>
</div>
</div>
<div class="section" id="defining-the-choice-value-object">
<h2>Defining the <code class="docutils literal notranslate"><span class="pre">Choice</span></code> value object…<a class="headerlink" href="#defining-the-choice-value-object" title="Permalink to this headline">¶</a></h2>
<p>TODO</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">minos.common</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ValueObject</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">Choice</span><span class="p">(</span><span class="n">ValueObject</span><span class="p">):</span>
    <span class="n">text</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">correct</span><span class="p">:</span> <span class="nb">bool</span>
</pre></div>
</div>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>TODO</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;src/aggregates.py&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">annotations</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">minos.common</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Aggregate</span><span class="p">,</span>
    <span class="n">AggregateRef</span><span class="p">,</span>
    <span class="n">Entity</span><span class="p">,</span>
    <span class="n">EntitySet</span><span class="p">,</span>
    <span class="n">ModelRef</span><span class="p">,</span>
    <span class="n">ValueObject</span><span class="p">,</span>
    <span class="n">ValueObjectSet</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">Exam</span><span class="p">(</span><span class="n">Aggregate</span><span class="p">):</span>
    <span class="n">subject</span><span class="p">:</span> <span class="n">ModelRef</span><span class="p">[</span><span class="n">Subject</span><span class="p">]</span>
    <span class="n">questions</span><span class="p">:</span> <span class="n">EntitySet</span><span class="p">[</span><span class="n">Question</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">parse_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">validate_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span>

<span class="k">class</span> <span class="nc">Subject</span><span class="p">(</span><span class="n">AggregateRef</span><span class="p">):</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">class</span> <span class="nc">Question</span><span class="p">(</span><span class="n">Entity</span><span class="p">):</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">choices</span><span class="p">:</span> <span class="n">ValueObjectSet</span><span class="p">[</span><span class="n">Choice</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">Choice</span><span class="p">(</span><span class="n">ValueObject</span><span class="p">):</span>
    <span class="n">text</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">correct</span><span class="p">:</span> <span class="nb">bool</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="command.html" class="btn btn-neutral float-right" title="Exposing Operations: Command Service" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="setup.html" class="btn btn-neutral float-left" title="Setup" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Clariteia.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>
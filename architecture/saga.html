

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>SAGA &mdash; Minos Documentation  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="API Reference" href="../api.html" />
    <link rel="prev" title="REST Handler" href="rest_handler.html" />
    <link href="../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Minos Documentation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart/_toc.html">QuickStart</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="_toc.html">Architecture</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="data_model.html">Data Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="messaging.html">Messaging</a></li>
<li class="toctree-l2"><a class="reference internal" href="cqrs.html">CQRS</a></li>
<li class="toctree-l2"><a class="reference internal" href="ports_and_adapters.html">Ports and Adapters</a></li>
<li class="toctree-l2"><a class="reference internal" href="rest_handler.html">REST Handler</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">SAGA</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#context">Context</a></li>
<li class="toctree-l3"><a class="reference internal" href="#problem">Problem</a></li>
<li class="toctree-l3"><a class="reference internal" href="#solution">Solution</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example">Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="#definitions">Definitions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#saga-structure">SAGA structure</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#step"><code class="docutils literal notranslate"><span class="pre">step()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#commit"><code class="docutils literal notranslate"><span class="pre">commit()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#sagacontext">SagaContext</a></li>
<li class="toctree-l3"><a class="reference internal" href="#saga-manager">SAGA Manager</a></li>
<li class="toctree-l3"><a class="reference internal" href="#query-building">Query building</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Minos Documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="_toc.html">Architecture</a> &raquo;</li>
        
      <li>SAGA</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/architecture/saga.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="saga">
<h1>SAGA<a class="headerlink" href="#saga" title="Permalink to this headline">¶</a></h1>
<div class="section" id="context">
<h2>Context<a class="headerlink" href="#context" title="Permalink to this headline">¶</a></h2>
<p>Minos framework apply <strong>Database per Service</strong> Pattern. Each service has its own database. Some business transactions,
however, span multiple service so we need a mechanism to implement transactions that span services.
For example, let’s imagine that we have an e-commerce store where customers have a credit limit.
The application must ensure that a new order will not exceed the customer’s credit limit. Since <code class="docutils literal notranslate"><span class="pre">Orders</span></code> and <code class="docutils literal notranslate"><span class="pre">Customers</span></code>
are in different databases owned by different services the application cannot simply use a local ACID transaction.</p>
</div>
<div class="section" id="problem">
<h2>Problem<a class="headerlink" href="#problem" title="Permalink to this headline">¶</a></h2>
<p>How do we implement transactions that affect several services?</p>
<p>In our case, how do we make Order and Customer communicate?</p>
</div>
<div class="section" id="solution">
<h2>Solution<a class="headerlink" href="#solution" title="Permalink to this headline">¶</a></h2>
<p>Implement each business transaction that spans multiple services is a saga. A saga is a sequence of local transactions.
Each local transaction updates the database and publishes a message or event to trigger the next local transaction in
the saga. If a local transaction fails because it violates a business rule then the saga executes a series of
compensating transactions that undo the changes that were made by the preceding local transactions.</p>
</div>
<div class="section" id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p>In the following example we are going to see how the saga is for the case of adding a <code class="docutils literal notranslate"><span class="pre">Product</span></code> to the <code class="docutils literal notranslate"><span class="pre">Cart</span></code>, we want
this product to be reserved for us.</p>
<div class="figure align-center">
<p class="plantuml">
<img src="../_images/plantuml-689ca07810471c2a57e3de5a82f76bcb935eaf7f.png" alt="&#64;startuml
actor User
box &quot;Microservice Cart&quot; #FFFFF3
participant &quot;add_to_cart()&quot;
participant SAGA
end box

box &quot;Microservice Product&quot; #F3FFF6
participant Product
end box

autonumber
User --&gt; &quot;add_to_cart()&quot;: Add item to cart
&quot;add_to_cart()&quot; -&gt; SAGA: Execute
SAGA -&gt; Product: Try to reserve the product
Product --&gt; SAGA: Product reserved
SAGA --&gt; SAGA: Add product to the cart
note left
In the commit method,
add item to cart
end note
SAGA --&gt; &quot;add_to_cart()&quot;: Success
&quot;add_to_cart()&quot; --&gt; User: Response
&#64;enduml"/>
</p>
</div>
</div>
<div class="section" id="definitions">
<h2>Definitions<a class="headerlink" href="#definitions" title="Permalink to this headline">¶</a></h2>
<p>It is important to differentiate the components involved, which are broadly speaking:</p>
<ul>
<li><p>SAGA</p>
<p>It is the <strong>definition of the different operations</strong> involved in the transaction in an orderly and hierarchical manner.
For example, to create an order we must reserve the products (microservice Product), generate the ticket or order
summary (microservice Ticket) and make the payment (microservice Payment). So the saga ensures that operations are
executed in a set manner, i.e. first the product is reserved, then the ticket is generated and finally the payment
is created.</p>
</li>
<li><p>SAGA Manager</p>
<blockquote>
<div><p>On the other hand, the saga manager is in charge of coordinating the execution of the SAGA’s.</p>
</div></blockquote>
</li>
</ul>
<div class="figure align-center">
<p class="plantuml">
<img src="../_images/plantuml-94973d2a285384c95d49dd9e6da35effb21d7321.png" alt="&#64;startuml
participant &quot;SAGA Manager&quot;
participant &quot;SAGA A&quot;
participant &quot;SAGA B&quot;
participant &quot;SAGA C&quot;

&quot;SAGA Manager&quot; -&gt; &quot;SAGA A&quot;: Run SAGA A
&quot;SAGA Manager&quot; -&gt; &quot;SAGA B&quot;: Run SAGA B
&quot;SAGA Manager&quot; -&gt; &quot;SAGA C&quot;: Run SAGA C
&quot;SAGA Manager&quot; --&gt; : ...
&#64;enduml"/>
</p>
</div>
</div>
<div class="section" id="saga-structure">
<h2>SAGA structure<a class="headerlink" href="#saga-structure" title="Permalink to this headline">¶</a></h2>
<p>The saga consists of steps and are those that define the operations to be performed in an orderly way to communicate with other
services. These steps normally contain the call to the corresponding service (<code class="docutils literal notranslate"><span class="pre">.invoke_participant(&quot;CreateOrder&quot;)</span></code>) and
optionally a compensation (<code class="docutils literal notranslate"><span class="pre">.with_compensation(&quot;DeleteOrder&quot;,</span> <span class="pre">delete_order_callback)</span></code>) in case an error occurs or the
operation cannot be performed by the business logic. It also optionally has a function in charge of
receiving the response from the invoked service (which is used in case the response has to be processed).</p>
<p>For a SAGA instance to be valid, a <code class="docutils literal notranslate"><span class="pre">step</span></code>, <code class="docutils literal notranslate"><span class="pre">invoke_participant</span></code> and <code class="docutils literal notranslate"><span class="pre">commit</span></code> are required. So the minimum structure of
a SAGA is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Saga</span><span class="p">()</span>
<span class="o">.</span><span class="n">step</span><span class="p">()</span>
<span class="o">.</span><span class="n">invoke_participant</span><span class="p">(</span><span class="s2">&quot;CreateOrder&quot;</span><span class="p">)</span>
<span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="step">
<h3><code class="docutils literal notranslate"><span class="pre">step()</span></code><a class="headerlink" href="#step" title="Permalink to this headline">¶</a></h3>
<p>As mentioned above, the <code class="docutils literal notranslate"><span class="pre">step()</span></code> is the minimum unit for a saga to work.</p>
<p>The step is used to define an operation and separate it from the rest, so a SAGA is usually a series of steps. Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">CREATE_ORDER</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">Saga</span><span class="p">(</span><span class="s2">&quot;CreateOrder&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">step</span><span class="p">()</span>
       <span class="o">.</span><span class="n">invoke_participant</span><span class="p">(</span><span class="s2">&quot;CreateTicket&quot;</span><span class="p">,</span> <span class="n">_create_ticket</span><span class="p">)</span>
       <span class="o">.</span><span class="n">on_reply</span><span class="p">(</span><span class="s2">&quot;ticket&quot;</span><span class="p">,</span> <span class="n">_process_ticket_entries</span><span class="p">)</span>
    <span class="o">.</span><span class="n">step</span><span class="p">()</span>
       <span class="o">.</span><span class="n">invoke_participant</span><span class="p">(</span><span class="s2">&quot;PurchaseProducts&quot;</span><span class="p">,</span> <span class="n">_purchase_products</span><span class="p">)</span>
       <span class="o">.</span><span class="n">with_compensation</span><span class="p">(</span><span class="s2">&quot;PurchaseProducts&quot;</span><span class="p">,</span> <span class="n">_revert_purchase_products</span><span class="p">)</span>
    <span class="o">.</span><span class="n">step</span><span class="p">()</span>
       <span class="o">.</span><span class="n">invoke_participant</span><span class="p">(</span><span class="s2">&quot;CreatePayment&quot;</span><span class="p">,</span> <span class="n">_payment</span><span class="p">)</span>
       <span class="o">.</span><span class="n">on_reply</span><span class="p">(</span><span class="s2">&quot;payment&quot;</span><span class="p">,</span> <span class="n">_get_payment</span><span class="p">)</span>
    <span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="n">_create_commit_callback</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The step in turn contains the following operations:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">invoke_participant(COMMAND,</span> <span class="pre">Callback</span> <span class="pre">function[Optional])</span></code></p>
<p>It is responsible for invoking a <code class="docutils literal notranslate"><span class="pre">Command</span></code> normally located in another microservice.</p>
<p>The callback function is optional and is used to prepare data or information to be sent with the <code class="docutils literal notranslate"><span class="pre">Command</span></code>.</p>
<p>Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">TicketQuery</span> <span class="o">=</span> <span class="n">ModelType</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="s2">&quot;TicketQuery&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;cart_uuid&quot;</span><span class="p">:</span> <span class="n">UUID</span><span class="p">})</span>

<span class="k">def</span> <span class="nf">_create_ticket</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">SagaContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Model</span><span class="p">:</span>
  <span class="n">cart_uuid</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;cart_uuid&quot;</span><span class="p">]</span>
  <span class="k">return</span> <span class="n">TicketQuery</span><span class="p">(</span><span class="n">cart_uuid</span><span class="p">)</span>

<span class="n">CREATE_ORDER</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">Saga</span><span class="p">(</span><span class="s2">&quot;CreateOrder&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">step</span><span class="p">()</span>
       <span class="o">.</span><span class="n">invoke_participant</span><span class="p">(</span><span class="s2">&quot;CreateTicket&quot;</span><span class="p">,</span> <span class="n">_create_ticket</span><span class="p">)</span>
       <span class="o">.</span><span class="n">on_reply</span><span class="p">(</span><span class="s2">&quot;ticket&quot;</span><span class="p">,</span> <span class="n">_process_ticket_entries</span><span class="p">)</span>
    <span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="n">_create_commit_callback</span><span class="p">)</span>
<span class="p">)</span>
<span class="c1"># The execution of the SAGA is omitted in this example ...</span>
</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">on_reply(Name,</span> <span class="pre">Callback</span> <span class="pre">function)</span></code> - <strong>Optional</strong></p>
<p>on reply is optional and is used if necessary to handle the result of the <code class="docutils literal notranslate"><span class="pre">invoke_participant</span></code>.
Important - The callback function of on_reply does not have access to the SagaContext. This is intentional since
on_reply is only used to process the data. On <code class="docutils literal notranslate"><span class="pre">return</span></code> it is automatically stored in SagaContext.
Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_get_payment</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Aggregate</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UUID</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">uuid</span>

<span class="n">CREATE_ORDER</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">Saga</span><span class="p">(</span><span class="s2">&quot;CreateOrder&quot;</span><span class="p">)</span>
      <span class="o">.</span><span class="n">step</span><span class="p">()</span>
      <span class="o">.</span><span class="n">invoke_participant</span><span class="p">(</span><span class="s2">&quot;CreatePayment&quot;</span><span class="p">,</span> <span class="n">_payment</span><span class="p">)</span>
      <span class="o">.</span><span class="n">on_reply</span><span class="p">(</span><span class="s2">&quot;payment&quot;</span><span class="p">,</span> <span class="n">_get_payment</span><span class="p">)</span>
    <span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="n">_commit</span><span class="p">)</span>
<span class="p">)</span>
<span class="c1"># The execution of the SAGA is omitted in this example ...</span>
</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">with_compensation(COMMAND,</span> <span class="pre">Callback</span> <span class="pre">function[Optional])</span></code> - <strong>Optional</strong></p>
<blockquote>
<div><p>In the event of an error in any of the operations, the compensation of the corresponding step and those of the
previous steps, if any, will be executed.</p>
<p>The callback function is optional and is used to prepare data or information to be sent with the <code class="docutils literal notranslate"><span class="pre">Command</span></code>.</p>
</div></blockquote>
</li>
</ul>
<div class="figure align-center">
<p class="plantuml">
<img src="../_images/plantuml-e216fd26c5db56c59e8a5bfb604295eaa25f0300.png" alt="&#64;startuml
participant &quot;SAGA Manager&quot;
participant &quot;SAGA CreateOrder&quot;
box &quot;Microservice Product&quot; #FFFFF3
participant &quot;PurchaseProducts&quot;
end box
box &quot;Microservice Payment&quot; #F3FFF6
participant &quot;CreatePayment&quot;
end box

autonumber
&quot;SAGA Manager&quot; -&gt; &quot;SAGA CreateOrder&quot;: Run
&quot;SAGA CreateOrder&quot; -&gt; &quot;PurchaseProducts&quot;: Purchase Products (Step 1)
&quot;PurchaseProducts&quot; --&gt; &quot;SAGA CreateOrder&quot;: Products Purchased (Step 1)
&quot;SAGA CreateOrder&quot; -&gt;x &quot;CreatePayment&quot;: Create Payment ERROR (Step 2)
&quot;SAGA CreateOrder&quot; -&gt; &quot;PurchaseProducts&quot;: Compensation (Step 1)
&quot;SAGA CreateOrder&quot; &lt;-- &quot;PurchaseProducts&quot;: Compensation OK (Step 1)
&#64;enduml"/>
</p>
</div>
</div>
<div class="section" id="commit">
<h3><code class="docutils literal notranslate"><span class="pre">commit()</span></code><a class="headerlink" href="#commit" title="Permalink to this headline">¶</a></h3>
<p>TODO</p>
</div>
</div>
<div class="section" id="sagacontext">
<h2>SagaContext<a class="headerlink" href="#sagacontext" title="Permalink to this headline">¶</a></h2>
<p>TODO</p>
</div>
<div class="section" id="saga-manager">
<h2>SAGA Manager<a class="headerlink" href="#saga-manager" title="Permalink to this headline">¶</a></h2>
<p>Saga manager is in charge of coordinating the execution of the saga or resuming the execution from disk or memory.</p>
<p>Previously we have seen how to define a SAGA, now we are going to see how to execute it.</p>
<p>Saga manager accepts the following parameters:</p>
<ul>
<li><p>SAGA Definition: Required</p>
<p>Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">CREATE_ORDER</span> <span class="o">=</span> <span class="p">(</span>
  <span class="n">Saga</span><span class="p">()</span>
  <span class="o">.</span><span class="n">step</span><span class="p">()</span>
  <span class="o">.</span><span class="n">invoke_participant</span><span class="p">(</span><span class="s2">&quot;CreateOrder&quot;</span><span class="p">)</span>
  <span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">pause_on_disk</span></code>: Optional (default <code class="docutils literal notranslate"><span class="pre">False</span></code>)</p>
<p>If it is paused on disk (<code class="docutils literal notranslate"><span class="pre">pause_on_disk=True</span></code>) it means that it is asynchronous, else if it is not paused on disk (<code class="docutils literal notranslate"><span class="pre">pause_on_disk=False</span></code>) it means that it is synchronous.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">raise_on_error</span></code>: Optional (default <code class="docutils literal notranslate"><span class="pre">True</span></code>)
Indicates what behaviour the SAGA should take in case of an error, being able to set it to <code class="docutils literal notranslate"><span class="pre">False</span></code> so that in case of
error no exception is thrown and other operations can be performed after the SAGA.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">return_execution</span></code>: Optional (default <code class="docutils literal notranslate"><span class="pre">True</span></code>)</p>
<p>If <code class="docutils literal notranslate"><span class="pre">return_execution=True</span></code>, the process that launched the SAGA would be waiting until the execution is finished,
being able to evaluate the result of this execution.
If <code class="docutils literal notranslate"><span class="pre">pause_on_disk=False</span></code>, the process that launched the SAGA receives the UUID of the SAGA execution and does not
wait for it to finish.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">context</span></code> Optional</p>
<p>Parameters that you want to send to SAGA in order to be able to operate with them. Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">context</span><span class="o">=</span><span class="n">SagaContext</span><span class="p">(</span>
  <span class="n">cart_uuid</span><span class="o">=</span><span class="n">cart_uuid</span><span class="p">,</span>
  <span class="n">customer_uuid</span><span class="o">=</span><span class="n">customer_uuid</span><span class="p">,</span>
  <span class="n">payment_detail</span><span class="o">=</span><span class="n">payment_detail</span><span class="p">,</span>
  <span class="n">shipment_detail</span><span class="o">=</span><span class="n">shipment_detail</span><span class="p">,</span>
<span class="p">),</span>
</pre></div>
</div>
<p>Within the SAGA you can access them in the following way:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">example_function</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">SagaContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SagaContext</span><span class="p">:</span>
  <span class="n">customer</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;customer_uuid&quot;</span><span class="p">]</span>
</pre></div>
</div>
</li>
</ul>
<p>Now we can see an example on how to run a <code class="docutils literal notranslate"><span class="pre">SAGA</span></code> with <code class="docutils literal notranslate"><span class="pre">SAGA</span> <span class="pre">Manager</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">CREATE_ORDER</span> <span class="o">=</span> <span class="p">(</span>
<span class="n">Saga</span><span class="p">(</span><span class="s2">&quot;CreateOrder&quot;</span><span class="p">)</span>
<span class="o">.</span><span class="n">step</span><span class="p">()</span>
<span class="o">.</span><span class="n">invoke_participant</span><span class="p">(</span><span class="s2">&quot;CreateTicket&quot;</span><span class="p">)</span>
<span class="o">.</span><span class="n">step</span><span class="p">()</span>
<span class="o">.</span><span class="n">invoke_participant</span><span class="p">(</span><span class="s2">&quot;CreatePayment&quot;</span><span class="p">)</span>
<span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="p">)</span>

<span class="o">...</span>

<span class="k">class</span> <span class="nc">OrderCommandService</span><span class="p">(</span><span class="n">CommandService</span><span class="p">):</span>
  <span class="nd">@enroute</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;/orders&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">)</span>
  <span class="nd">@enroute</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;CreateOrder&quot;</span><span class="p">)</span>
  <span class="k">async</span> <span class="k">def</span> <span class="nf">create_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="n">saga</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">saga_manager</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="n">CREATE_ORDER</span><span class="p">,</span>
        <span class="n">context</span><span class="o">=</span><span class="n">SagaContext</span><span class="p">(</span>
            <span class="n">cart_uuid</span><span class="o">=</span><span class="n">cart_uuid</span><span class="p">,</span>
            <span class="n">customer_uuid</span><span class="o">=</span><span class="n">customer_uuid</span><span class="p">,</span>
            <span class="n">payment_detail</span><span class="o">=</span><span class="n">payment_detail</span><span class="p">,</span>
            <span class="n">shipment_detail</span><span class="o">=</span><span class="n">shipment_detail</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="query-building">
<h2>Query building<a class="headerlink" href="#query-building" title="Permalink to this headline">¶</a></h2>
<p>TODO</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../api.html" class="btn btn-neutral float-right" title="API Reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="rest_handler.html" class="btn btn-neutral float-left" title="REST Handler" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Clariteia.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>
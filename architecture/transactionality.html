

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Transactionality &mdash; Minos Documentation  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="API Reference" href="../api.html" />
    <link rel="prev" title="Decorators" href="decorators.html" />
    <link href="../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Minos Documentation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart/_toc.html">QuickStart</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="_toc.html">Architecture</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="data_model.html">Data Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="messaging.html">Messaging</a></li>
<li class="toctree-l2"><a class="reference internal" href="ports_and_adapters.html">Ports and Adapters</a></li>
<li class="toctree-l2"><a class="reference internal" href="rest_handler.html">REST Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="saga.html">SAGA</a></li>
<li class="toctree-l2"><a class="reference internal" href="decorators.html">Decorators</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Transactionality</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#broker">Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="#handler">Handler</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Minos Documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="_toc.html">Architecture</a> &raquo;</li>
        
      <li>Transactionality</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/architecture/transactionality.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="transactionality">
<h1>Transactionality<a class="headerlink" href="#transactionality" title="Permalink to this headline">¶</a></h1>
<p>To ensure transactionality in the exchange of information between the different services or itself, the <code class="docutils literal notranslate"><span class="pre">Broker</span></code> is
used to store the information in the database and <code class="docutils literal notranslate"><span class="pre">Handler</span></code> to retrieve it.</p>
<p>For more details on full workflow of how messages are processed see <a class="reference external" href="./messaging.html">Messaging introduction</a>.</p>
<p>In this section we will detail the components shown in green in the following diagram:</p>
<div class="figure align-center">
<p class="plantuml">
<img src="../_images/plantuml-802d835e05d12e04db7cab7923d709cc416c0197.png" alt="&#64;startuml
box &quot;Message Publishing - Microservice X&quot; #FFFFF3
participant Broker #99FF99
database DB_A
participant Producer
end box
database Kafka
box &quot;Message Receiving - Microservice Y&quot; #F3FFF6
participant Consumer
database DB_B
participant Handler #99FF99
end box

--&gt; Broker: send

Broker -&gt; DB_A: Store Message
Broker -&gt; DB_A: Notify
DB_A -&gt; Producer: ...
Producer --&gt; DB_A: ...
Producer --&gt; Kafka: ...
Kafka &lt;--&gt; Consumer: ...
Consumer -&gt; DB_B: ...
DB_B -&gt; Handler: Notify
Handler --&gt; DB_B: Get Message
Handler --&gt; :Trigger action
&#64;enduml"/>
</p>
</div>
<p><strong>For the following explanations we will assume that the Broker aggregates messages in the local DB of
microservice X and Handler is the one that obtains them from the DB of microservice Y. This is to base the
example on the communication of 2 microservices instead of one.</strong></p>
<div class="section" id="broker">
<h2>Broker<a class="headerlink" href="#broker" title="Permalink to this headline">¶</a></h2>
<p>The broker is in charge of <strong>adding messages</strong> to the microservice’s local database and <strong>triggering a notification</strong>
to let know <code class="docutils literal notranslate"><span class="pre">Producer</span></code> that there are new messages.</p>
<div class="figure align-center">
<p class="plantuml">
<img src="../_images/plantuml-ac85219872e8893d418b3fc0db444574e91fe853.png" alt="&#64;startuml
box &quot;Message Publishing - Microservice X&quot; #FFFFF3
participant Broker
database DB_A
end box

autonumber
--&gt; Broker: send

Broker -&gt; DB_A: Store Message
Broker -&gt; DB_A: Notify
&#64;enduml"/>
</p>
</div>
<ol class="arabic">
<li><p>Receive the message and add it to the database</p>
<p>The received message is stored in the <code class="docutils literal notranslate"><span class="pre">PostgreSQL</span></code> database of the corresponding microservice.
The table where the message is stored has the following structure:</p>
<div class="highlight-SQL notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">producer_queue</span> <span class="p">(</span>
<span class="n">id</span> <span class="n">BIGSERIAL</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
<span class="n">topic</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="k">data</span> <span class="n">BYTEA</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="n">action</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="n">retry</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="mi">0</span><span class="p">,</span>
<span class="n">created_at</span> <span class="n">TIMESTAMPTZ</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="n">NOW</span><span class="p">(),</span>
<span class="n">updated_at</span> <span class="n">TIMESTAMPTZ</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="n">NOW</span><span class="p">())</span>
</pre></div>
</div>
</li>
<li><p>Trigger notify action to the database</p>
<p>The Broker triggers a notification to let the Producer know that new messages are available.</p>
<div class="highlight-SQL notranslate"><div class="highlight"><pre><span></span><span class="k">NOTIFY</span> <span class="n">producer_queue</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="handler">
<h2>Handler<a class="headerlink" href="#handler" title="Permalink to this headline">¶</a></h2>
<p>It is responsible of getting the message from database and triggering the final action (calling the function that
is subscribed to the message for example).</p>
<ol class="arabic">
<li><p>Listens to new messages</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Handler</span></code> is actively listening for new messages using the following SQL:</p>
<div class="highlight-SQL notranslate"><div class="highlight"><pre><span></span><span class="k">LISTEN</span> <span class="n">consumer_queue</span>
</pre></div>
</div>
</li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">Handler</span></code> is notified of new messages</p>
<p>Reads from the database table (mentioned in step 1) obtaining the new messages.</p>
</li>
<li><p>Final action is triggered</p>
<p>The message have several <strong>attempts</strong> to be consumed in the database (parameterizable). As an example, we set the
number of retries to 3, if on the third attempt the message is not triggered to action correctly, it is marked to not be
processed any more times.</p>
<div class="figure align-center">
<p class="plantuml">
<img src="../_images/plantuml-533e7be09296aa544e244d67388c06db70e8cac8.png" alt="&#64;startuml
box &quot;Message Receiving - Microservice Y&quot; #F3FFF6
database DB_B
participant Handler
end box

DB_B -&gt; Handler: Notify
Handler --&gt; DB_B: Get Message
Handler -&gt;x Action :Trigger action
Handler -&gt;x Action :Trigger action
Handler -&gt;x Action :Trigger action
Handler -&gt; DB_B: Message marked for no further processing
&#64;enduml"/>
</p>
</div>
</li>
<li><p>If the message has been published, it is deleted</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Handler</span></code> takes care of deleting the message from the local database once it has been successfully consumed.</p>
</li>
</ol>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../api.html" class="btn btn-neutral float-right" title="API Reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="decorators.html" class="btn btn-neutral float-left" title="Decorators" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Clariteia.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>